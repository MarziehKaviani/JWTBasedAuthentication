<hr><h1>JWTBasedAuthentication</h1><p>A robust Django-based authentication system utilizing JSON Web Tokens (JWT) for secure and scalable user authentication. This system includes JWT-based bearer token authentication, phone number and OTP login, and identity verification integration with the Zibal API.</p><h2>Table of Contents</h2><ul><li><a rel="noreferrer" href="#overview">Overview</a></li><li><a rel="noreferrer" href="#features">Features</a></li><li><a rel="noreferrer" href="#requirements">Requirements</a></li><li><a rel="noreferrer" href="#installation">Installation</a></li><li><a rel="noreferrer" href="#configuration">Configuration</a></li><li><a rel="noreferrer" href="#usage">Usage</a><ul><li><a rel="noreferrer" href="#api-endpoints">API Endpoints</a></li><li><a rel="noreferrer" href="#authentication-flow">Authentication Flow</a></li><li><a rel="noreferrer" href="#identity-verification">Identity Verification</a></li></ul></li><li><a rel="noreferrer" href="#testing">Testing</a></li><li><a rel="noreferrer" href="#contributing">Contributing</a></li></ul><h2><span style="color: green;">Overview</span></h2><p>This project provides a comprehensive authentication solution using JWT tokens. It includes features such as anonymous access tokens, phone number verification via OTP, and user identity verification using the Zibal API.</p><p>The core functionality revolves around generating and validating JWT tokens for authenticated and anonymous users, allowing secure access to various APIs within the system.</p><h2>Features</h2><ul><li><strong>JWT-Based Authentication</strong>: Secure APIs with JWT tokens, including mechanisms for token refresh and anonymous tokens.</li><li><strong>Anonymous User Access</strong>: Allow users to interact with the system as anonymous users with restricted access until they complete the login process.</li><li><strong>Phone Number &amp; OTP Login</strong>: Authenticate users through phone number and OTP without requiring a password.</li><li><strong>User Identity Verification</strong>: Verify user identity against Zibal API, ensuring phone numbers and national IDs are correctly associated.</li><li><strong>Blocking Mechanism</strong>: Implement user blocking by leveraging Redis to manage the state of blocked users effectively.</li><li><strong>Nextcloud Integration</strong>: Integration with Nextcloud for document management.</li></ul><h2>Requirements</h2><ul><li>Python 3.8+</li><li>Django 3.2+</li><li>Django Rest Framework (DRF) 3.12+</li><li>Redis (for managing blocked users)</li><li>RabbitMQ (for asynchronous messaging)</li><li>PostgreSQL (as the primary database)</li><li>Docker &amp; Docker Compose (for containerized deployment)</li></ul><h2>Installation</h2><p>Follow these steps to set up the project locally:</p><ol><li><p><strong>Clone the repository:</strong></p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span></span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-bash">git <span class="hljs-built_in">clone</span> https://github.com/yourusername/JWTBasedAuthentication.git
<span class="hljs-built_in">cd</span> JWTBasedAuthentication
</code></div></div></pre></li><li><p><strong>Create and activate a virtual environment:</strong></p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span></span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-bash">python -m venv venv
<span class="hljs-built_in">source</span> venv/bin/activate   <span class="hljs-comment"># On Windows use `venv\Scripts\activate`</span>
</code></div></div></pre></li><li><p><strong>Install the dependencies:</strong></p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span></span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-bash">pip install -r requirements.txt
</code></div></div></pre></li><li><p><strong>Apply migrations:</strong></p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span></span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-bash">python manage.py migrate
</code></div></div></pre></li><li><p><strong>Run the development server:</strong></p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span></span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-bash">python manage.py runserver
</code></div></div></pre></li></ol><p>For a production setup, use Docker and Docker Compose:</p><ol><li><p><strong>Build and start the Docker containers:</strong></p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span></span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-bash">docker-compose up --build
</code></div></div></pre></li><li><p><strong>Access the application:</strong>
Open your browser and navigate to <code>http://localhost:8000</code>.</p></li></ol><h2>Configuration</h2><h3>Environment Variables</h3><p>Configure the following environment variables in your <code>.env</code> file for the project:</p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span></span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-bash"><span class="hljs-comment"># General settings</span>
SECRET_KEY=your_secret_key
DEBUG=True

<span class="hljs-comment"># Redis configuration</span>
REDIS_HOST=localhost
REDIS_PORT=6379

<span class="hljs-comment"># PostgreSQL configuration</span>
DATABASE_HOST=localhost
DATABASE_PORT=5432
POSTGRES_DB=your_db_name
POSTGRES_USER=your_db_user
POSTGRES_PASSWORD=your_db_password

<span class="hljs-comment"># RabbitMQ configuration</span>
RABBITMQ_DEFAULT_USER=your_rabbitmq_user
RABBITMQ_DEFAULT_PASS=your_rabbitmq_password
RABBITMQ_URL=amqp://your_rabbitmq_user:your_rabbitmq_password@localhost:5672/

<span class="hljs-comment"># Kavenegar API for OTP</span>
KAVENEGAR_API_KEY=your_kavenegar_api_key

<span class="hljs-comment"># Zibal API for identity verification</span>
ZIBAL_TOKEN=your_zibal_token

<span class="hljs-comment"># Nextcloud (Owncloud) configuration</span>
OWNCLOUD_VERSION=your_owncloud_version
OWNCLOUD_DOMAIN=your_owncloud_domain
OWNCLOUD_TRUSTED_DOMAINS=your_trusted_domains
ADMIN_USERNAME_NEXT_CLOUD=your_admin_username
ADMIN_PASSWORD_NEXT_CLOUD=your_admin_password
ADMIN_USERNAME_MARIA_DB=your_mariadb_admin_username
ADMIN_PASSWORD_MARIA_DB=your_mariadb_admin_password
ROOT_PASSWORD_MARIA_DB=your_mariadb_root_password
OWNCLOUD_ADMIN_USERNAME=your_owncloud_admin_username
OWNCLOUD_ADMIN_PASSWORD=your_owncloud_admin_password
OWNCLOUD_FLAGS_DIRECTORY_PATH=/path/to/owncloud/flags
</code></div></div></pre><h3>Django Settings</h3><p>Adjust any necessary settings in the <code>settings.py</code> file, particularly under <code>JWTBasedAuthentication/settings.py</code> and <code>authentication/settings.py</code>.</p><p><strong>Example:</strong></p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span>python</span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-python"><span class="hljs-comment"># settings.py</span>

<span class="hljs-keyword">import</span> os

SECRET_KEY = os.getenv(<span class="hljs-string">'SECRET_KEY'</span>)
DEBUG = os.getenv(<span class="hljs-string">'DEBUG'</span>, <span class="hljs-string">'False'</span>) == <span class="hljs-string">'True'</span>

<span class="hljs-comment"># Database</span>
DATABASES = {
    <span class="hljs-string">'default'</span>: {
        <span class="hljs-string">'ENGINE'</span>: <span class="hljs-string">'django.db.backends.postgresql'</span>,
        <span class="hljs-string">'NAME'</span>: os.getenv(<span class="hljs-string">'POSTGRES_DB'</span>),
        <span class="hljs-string">'USER'</span>: os.getenv(<span class="hljs-string">'POSTGRES_USER'</span>),
        <span class="hljs-string">'PASSWORD'</span>: os.getenv(<span class="hljs-string">'POSTGRES_PASSWORD'</span>),
        <span class="hljs-string">'HOST'</span>: os.getenv(<span class="hljs-string">'DATABASE_HOST'</span>),
        <span class="hljs-string">'PORT'</span>: os.getenv(<span class="hljs-string">'DATABASE_PORT'</span>),
    }
}

<span class="hljs-comment"># Redis configuration</span>
REDIS_HOST = os.getenv(<span class="hljs-string">'REDIS_HOST'</span>, <span class="hljs-string">'localhost'</span>)
REDIS_PORT = os.getenv(<span class="hljs-string">'REDIS_PORT'</span>, <span class="hljs-string">'6379'</span>)

<span class="hljs-comment"># RabbitMQ configuration</span>
RABBITMQ_URL = os.getenv(<span class="hljs-string">'RABBITMQ_URL'</span>)
</code></div></div></pre><h2>Usage</h2><h3>API Endpoints</h3><p>Here's a breakdown of the main endpoints available in this system:</p><ul><li><strong>Anonymous User Token</strong><ul><li><code>POST /api/anonymous_user/</code>: Generate a token for anonymous access.</li></ul></li><li><strong>Phone Number Verification</strong><ul><li><code>POST /api/verification_code/</code>: Request an OTP for phone number verification.</li></ul></li><li><strong>User Login</strong><ul><li><code>POST /api/login/</code>: Log in using phone number and OTP to receive a JWT token.</li></ul></li><li><strong>Token Refresh</strong><ul><li><code>POST /api/token/refresh/</code>: Refresh the JWT access token.</li></ul></li><li><strong>User Profile</strong><ul><li><code>GET /api/profile/</code>: Retrieve the authenticated user's profile information.</li></ul></li><li><strong>Identity Verification</strong><ul><li><code>POST /api/verify_user/</code>: Verify user identity using national ID and phone number.</li></ul></li></ul><h3>Authentication Flow</h3><ol><li><strong>Anonymous Access</strong>: A user first interacts with the system as an anonymous user by obtaining an anonymous token.</li><li><strong>Phone Number Verification</strong>: The user requests an OTP to be sent to their phone number.</li><li><strong>Login</strong>: The user logs in using their phone number and OTP, receiving a JWT access token.</li><li><strong>Authenticated Access</strong>: The JWT access token is used to access authenticated endpoints.</li><li><strong>Token Refresh</strong>: The JWT token can be refreshed when needed.</li></ol><h3>Identity Verification</h3><p>The identity verification process involves validating the user's national ID and phone number against the Zibal API. Once the user is verified, their profile is updated with additional data such as birth date, full name, and alive status.</p><h2>Testing</h2><p>The project includes comprehensive unit and integration tests. To run the tests, use the following command:</p><pre><div class="dark bg-gray-950 rounded-md border-[0.5px] border-token-border-medium"><div class="flex items-center relative text-token-text-secondary bg-token-main-surface-secondary px-4 py-2 text-xs font-sans justify-between rounded-t-md"><span></span><div class="flex items-center"><span class="" data-state="closed"><button class="flex gap-1 items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg></button></span></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="!whitespace-pre hljs language-bash">python manage.py <span class="hljs-built_in">test</span>
</code></div></div></pre><p>Tests are organized under:</p><ul><li><code>authentication/v1/unit_tests/</code></li><li><code>authentication/v1/integration_tests/</code></li></ul><h2>Contributing</h2><p>Contributions are welcome! Please follow these guidelines:</p><ol><li><strong>Fork the repository</strong> and create your branch from <code>main</code>.</li><li><strong>Commit your changes</strong>: Ensure your changes include tests if applicable.</li><li><strong>Push to your branch</strong> and submit a pull request.</li></ol><p>Please make sure to update tests as appropriate and adhere to the project's coding standards.</p></div>